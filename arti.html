<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hecturia AI</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --primary-color: #16213e;
            --secondary-color: #0f3460;
            --accent-icy-blue: #89cff0;
            --accent-icy-purple: #c3aed6;
            --text-color: #e0e0e0;
            --glass-bg: rgba(22, 33, 62, 0.55);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(45deg, var(--bg-color), #2c3e50);
        }

        .chat-container {
            width: 95%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            background: rgba(15, 52, 96, 0.5);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h2 {
            color: var(--accent-icy-blue);
            text-shadow: 0 0 5px var(--accent-icy-blue);
        }

        .backup-controls button {
            background: none;
            border: 1px solid var(--accent-icy-purple);
            color: var(--accent-icy-purple);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .backup-controls button:hover {
            background-color: var(--accent-icy-purple);
            color: var(--primary-color);
            box-shadow: 0 0 15px var(--accent-icy-purple);
        }

        #file-importer {
            display: none;
        }
        
        .chat-box {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .chat-box::-webkit-scrollbar {
            width: 8px;
        }

        .chat-box::-webkit-scrollbar-thumb {
            background-color: var(--accent-icy-blue);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 70%;
            line-height: 1.6;
        }

        .user-message {
            background-color: var(--accent-icy-blue);
            color: var(--primary-color);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background-color: var(--secondary-color);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .ai-message button {
            background-color: var(--accent-icy-purple);
            color: var(--primary-color);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-family: 'Vazirmatn', sans-serif;
            transition: all 0.3s ease;
        }
        
        .ai-message button:hover {
            box-shadow: 0 0 15px var(--accent-icy-purple);
        }

        .chat-input {
            display: flex;
            padding: 20px;
            border-top: 1px solid var(--glass-border);
        }

        #user-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--accent-icy-blue);
            border-radius: 10px;
            background-color: var(--glass-bg);
            color: var(--text-color);
            font-size: 16px;
            margin-left: 10px;
        }

        #send-btn {
            padding: 12px 25px;
            border: none;
            background-color: var(--accent-icy-blue);
            color: var(--primary-color);
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        #send-btn:hover {
            box-shadow: 0 0 15px var(--accent-icy-blue);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            color: var(--text-color);
            position: relative;
        }

        .modal-content h3 {
            color: var(--accent-icy-blue);
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .modal-content input, .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--accent-icy-purple);
            background-color: var(--glass-bg);
            color: var(--text-color);
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Vazirmatn', sans-serif;
            transition: all 0.3s ease;
        }

        .btn-save {
            background-color: var(--accent-icy-blue);
            color: var(--primary-color);
            border: none;
        }
        
        .btn-save:hover {
            box-shadow: 0 0 15px var(--accent-icy-blue);
        }

        .btn-cancel {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--text-color);
        }
        
        .btn-add {
            background-color: var(--accent-icy-purple);
            color: var(--primary-color);
            border: none;
        }
        
        .formula-step {
            border: 1px dashed var(--accent-icy-purple);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

    </style>
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">
            <h2>Hecturia AI</h2>
            <div class="backup-controls">
                <button id="import-btn">بارگذاری دانش</button>
                <input type="file" id="file-importer" accept=".hfc">
                <button id="export-btn">پشتیبان‌گیری</button>
            </div>
        </div>
        <div class="chat-box" id="chat-box">
            </div>
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="پیام خود را بنویسید...">
            <button id="send-btn">ارسال</button>
        </div>
    </div>

    <div id="learningModal" class="modal">
        <div class="modal-content">
            <h3>یادگیری مکالمه جدید</h3>
            <label for="new-question">سوالی که متوجه نشدم:</label>
            <input type="text" id="new-question" readonly>
            
            <label for="new-answers">جواب(های) صحیح (برای چند جواب، هر کدام را در یک خط جدید بنویسید):</label>
            <textarea id="new-answers" rows="4" placeholder="مثلا:\nممنون، خوبم.\nعالی‌ام، تو چطوری؟"></textarea>
            
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('learningModal')">انصراف</button>
                <button class="btn-save" onclick="saveNewQA()">ذخیره</button>
            </div>
        </div>
    </div>

    <div id="formulaModal" class="modal">
        <div class="modal-content">
            <h3>افزودن فرمول جدید فیزیک</h3>
            <label for="formula-name">نام فرمول:</label>
            <input type="text" id="formula-name" placeholder="مثال: تبدیل سانتی‌متر به متر">

            <div id="formula-steps-container">
                </div>
            
            <button class="btn-add" onclick="addFormulaStep()">+ افزودن متغیر یا عملیات</button>
            
            <label for="formula-output">فرمت نمایش نتیجه:</label>
            <input type="text" id="formula-output" placeholder="مثال: {نتیجه} متر">
            
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('formulaModal')">انصراف</button>
                <button class="btn-save" onclick="saveNewFormula()">ذخیره فرمول</button>
            </div>
        </div>
    </div>
    
    <div id="encryptionModal" class="modal">
        <div class="modal-content">
            <h3>ساخت/استفاده از رمزنگار</h3>
            <label for="cipher-name">نام رمز:</label>
            <input type="text" id="cipher-name" placeholder="مثال: انیگما شخصی من">
            
            <label>قوانین رمزنگاری (جایگزینی حروف):</label>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="cipher-from" placeholder="حروف اصلی: ابپتثج">
                <input type="text" id="cipher-to" placeholder="حروف جایگزین: تپبثاج">
            </div>
            <p style="font-size: 12px; margin-top: -10px; margin-bottom: 15px;">طول دو رشته باید یکسان باشد.</p>
            <button class="btn-save" onclick="saveCipher()">ذخیره رمز</button>
            <hr style="margin: 20px 0; border-color: var(--glass-border);">
            
            <select id="cipher-selector" style="width: 100%; padding: 10px; margin-bottom: 10px; background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--accent-icy-purple);"></select>

            <textarea id="cipher-text" rows="3" placeholder="متن برای رمزنگاری یا رمزگشایی..."></textarea>
            
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('encryptionModal')">بستن</button>
                <button class="btn-add" onclick="performCipher(false)">رمزگشایی</button>
                <button class="btn-save" onclick="performCipher(true)">رمزنگاری</button>
            </div>
        </div>
    </div>


    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        let hecturiaDB = {
            qa: {},
            formulas: {},
            ciphers: {}
        };
        
        const initialQA = {
            "سلام": ["سلام! چطور میتونم کمکت کنم؟", "درود بر شما!", "سلام، من هکتوریا هستم."],
            "خوبی": ["ممنون که پرسیدی! من یک هوش مصنوعی هستم و همیشه در بهترین حالت قرار دارم.", "عالی‌ام! آماده‌ام تا بهت کمک کنم."],
            "چه خبر": ["همه چیز تحت کنترله!", "خبر خاصی نیست، منتظر دستورات شما هستم."],
            "اسمت چیه": ["من هکتوریا هستم.", "اسم من هکتوریا است."],
            "کجایی": ["من در دستگاه شما و آماده به خدمت هستم!", "من همه جا و هیچ جا نیستم. یک کد در سیستم شما."]
        };

        function loadDB() {
            const db = localStorage.getItem('hecturiaDB');
            if (db) {
                hecturiaDB = JSON.parse(db);
            } else {
                hecturiaDB.qa = initialQA;
            }
        }

        function saveDB() {
            localStorage.setItem('hecturiaDB', JSON.stringify(hecturiaDB));
        }

        function addMessage(text, sender, contentHTML = '') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            if (contentHTML) {
                messageDiv.innerHTML = contentHTML;
            } else {
                messageDiv.textContent = text;
            }
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function getAIResponse(query) {
            query = query.trim();

            // Keyword triggers
            if (query.includes("فیزیک")) {
                return handlePhysics();
            }
            if (query.includes("رمزنگاری") || query.includes("رمز")) {
                return handleEncryption();
            }
            if (query.includes("یادگیری")) {
                addMessage("برای یادگیری، کافیه چیزی از من بپرسید که بلد نیستم. خودم ازتون می‌خوام که بهم یاد بدید!", 'ai');
                return;
            }

            // General QA
            for (const key in hecturiaDB.qa) {
                if (query.includes(key)) {
                    const answers = hecturiaDB.qa[key];
                    const randomAnswer = answers[Math.floor(Math.random() * answers.length)];
                    return randomAnswer;
                }
            }
            
            // Not found
            const learnButtonId = `learn-btn-${Date.now()}`;
            const responseText = `متاسفم، من جواب این سوال رو نمی‌دونم. \n<button id="${learnButtonId}" data-question="${query}">یادگیری</button>`;
            addMessage('', 'ai', responseText);

            setTimeout(() => {
                const learnBtn = document.getElementById(learnButtonId);
                if (learnBtn) {
                    learnBtn.onclick = () => {
                        openLearningModal(learnBtn.dataset.question);
                    };
                }
            }, 100);
        }

        function handleSend() {
            const userText = userInput.value;
            if (!userText.trim()) return;

            addMessage(userText, 'user');
            userInput.value = '';

            setTimeout(() => {
                const aiResponse = getAIResponse(userText);
                if (aiResponse) {
                    addMessage(aiResponse, 'ai');
                }
            }, 500);
        }

        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });

        // --- Modal Logic ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- Learning Module ---
        function openLearningModal(question) {
            document.getElementById('new-question').value = question;
            document.getElementById('new-answers').value = '';
            openModal('learningModal');
        }

        function saveNewQA() {
            const question = document.getElementById('new-question').value.trim();
            const answersRaw = document.getElementById('new-answers').value.trim();
            if (!question || !answersRaw) return;

            const answers = answersRaw.split('\n').map(a => a.trim()).filter(a => a);
            hecturiaDB.qa[question] = answers;
            saveDB();
            
            addMessage(`بسیار خب! یاد گرفتم که در جواب "${question}" چه بگویم.`, 'ai');
            closeModal('learningModal');
        }
        
        // --- Physics Module ---
        function handlePhysics() {
            let response = "بله، می‌توانم در زمینه فیزیک کمک کنم.<br>فرمول‌هایی که بلدم:";
            if(Object.keys(hecturiaDB.formulas).length > 0) {
                 response += "<ul>";
                 for(const name in hecturiaDB.formulas) {
                     response += `<li>${name}</li>`;
                 }
                 response += "</ul>";
            } else {
                response += "<br>در حال حاضر هیچ فرمولی بلد نیستم.";
            }
            response += `<br><button onclick="openFormulaModal()">افزودن فرمول جدید</button>`;
            addMessage("", "ai", response);
        }

        function openFormulaModal() {
            document.getElementById('formula-name').value = '';
            document.getElementById('formula-steps-container').innerHTML = '';
            document.getElementById('formula-output').value = '';
            openModal('formulaModal');
        }

        let stepCounter = 0;
        function addFormulaStep() {
            stepCounter++;
            const container = document.getElementById('formula-steps-container');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'formula-step';
            stepDiv.innerHTML = `
                <label>مرحله ${stepCounter}:</label>
                <select onchange="updateStepType(this)">
                    <option value="variable">تعریف متغیر</option>
                    <option value="operation">انجام عملیات</option>
                </select>
                <div class="step-details">
                    <input type="text" class="step-input" placeholder="نام متغیر (مثال: سانتی‌متر)">
                </div>
            `;
            container.appendChild(stepDiv);
        }
        
        function updateStepType(selectElement) {
            const detailsDiv = selectElement.nextElementSibling;
            if (selectElement.value === 'variable') {
                detailsDiv.innerHTML = `<input type="text" class="step-input" placeholder="نام متغیر (مثال: سانتی‌متر)">`;
            } else {
                detailsDiv.innerHTML = `<input type="text" class="step-input" placeholder="عملیات (مثال: var1 / 100)">`;
            }
        }
        
        function saveNewFormula() {
            const name = document.getElementById('formula-name').value.trim();
            const output = document.getElementById('formula-output').value.trim();
            if(!name || !output) return;
            
            const steps = [];
            const stepDivs = document.querySelectorAll('#formula-steps-container .formula-step');
            stepDivs.forEach(div => {
                const type = div.querySelector('select').value;
                const value = div.querySelector('.step-input').value.trim();
                steps.push({ type, value });
            });
            
            hecturiaDB.formulas[name] = { steps, output };
            saveDB();
            addMessage(`فرمول "${name}" با موفقیت ذخیره شد.`, 'ai');
            closeModal('formulaModal');
        }

        // --- Encryption Module ---
        function handleEncryption() {
            updateCipherSelector();
            openModal('encryptionModal');
            return "ماژول رمزنگاری برای شما باز شد.";
        }
        
        function saveCipher() {
            const name = document.getElementById('cipher-name').value.trim();
            const from = document.getElementById('cipher-from').value;
            const to = document.getElementById('cipher-to').value;
            
            if (!name || !from || !to || from.length !== to.length) {
                alert("لطفا نام رمز و حروف اصلی و جایگزین را به درستی وارد کنید. طول حروف باید یکسان باشد.");
                return;
            }
            
            hecturiaDB.ciphers[name] = { from, to };
            saveDB();
            alert(`رمز "${name}" ذخیره شد.`);
            updateCipherSelector();
        }
        
        function updateCipherSelector() {
            const selector = document.getElementById('cipher-selector');
            selector.innerHTML = '';
            for (const name in hecturiaDB.ciphers) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selector.appendChild(option);
            }
        }
        
        function performCipher(encrypt) {
            const cipherName = document.getElementById('cipher-selector').value;
            const text = document.getElementById('cipher-text').value;
            if (!cipherName || !text) return;
            
            const cipher = hecturiaDB.ciphers[cipherName];
            let from, to;
            if (encrypt) {
                [from, to] = [cipher.from, cipher.to];
            } else {
                [from, to] = [cipher.to, cipher.from];
            }
            
            const map = {};
            for (let i = 0; i < from.length; i++) {
                map[from[i]] = to[i];
            }
            
            const result = text.split('').map(char => map[char] || char).join('');
            document.getElementById('cipher-text').value = result;
        }

        // --- Backup & Restore ---
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const fileImporter = document.getElementById('file-importer');

        exportBtn.addEventListener('click', () => {
            const dataStr = JSON.stringify(hecturiaDB, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hecturia_backup.hfc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addMessage("پشتیبان‌گیری از دانش با موفقیت انجام شد.", 'ai');
        });
        
        importBtn.addEventListener('click', () => fileImporter.click());

        fileImporter.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedDB = JSON.parse(e.target.result);
                    // Basic validation
                    if ('qa' in importedDB && 'formulas' in importedDB && 'ciphers' in importedDB) {
                        hecturiaDB = importedDB;
                        saveDB();
                        addMessage("دانش جدید با موفقیت بارگذاری و جایگزین شد!", 'ai');
                    } else {
                        throw new Error("Invalid file format");
                    }
                } catch (error) {
                    addMessage("خطا: فایل پشتیبان معتبر نیست.", 'ai');
                }
            };
            reader.readAsText(file);
            fileImporter.value = ''; // Reset for next import
        });

        // --- Initial Load ---
        window.onload = () => {
            loadDB();
            addMessage("سلام! من هکتوریا هستم. چطور میتونم کمکت کنم؟ می‌تونی از من سوال بپرسی یا کلمات کلیدی مثل 'فیزیک' یا 'رمزنگاری' رو امتحان کنی.", 'ai');
        };

    </script>
</body>
</html>
